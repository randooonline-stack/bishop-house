<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bishop House ‚Äî Omni Portal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
/* --- CORE STYLES --- */
:root{--neon:#00ff66;--blue:#00aaff;--red:#ff3333;--bg:#000;--muted:#88ffb3;--term-bg:#0c0c0c}
html,body{height:100%;margin:0;background:var(--bg);color:var(--neon);font-family:ui-monospace, Menlo, Monaco, "Courier New", monospace;overflow:hidden}
a{color:var(--neon);text-decoration:none}
button{cursor:pointer}
* { box-sizing: border-box; }

#bg { position:fixed; inset:0; z-index:0; pointer-events:none; background: radial-gradient(rgba(0,255,102,0.03), rgba(0,0,0,0)); }
#termuxWallpaper{ position:fixed; inset:0; z-index:0; pointer-events:none; background:#000; display:none; overflow:hidden; opacity: 0; transition: opacity 1s; }
#termuxWallpaper.active{ opacity: 1; }
.termuxLayer{ position:absolute; inset:0; font-family:monospace; white-space:pre; line-height:1.05; font-size:12px; color:rgba(0,255,102,0.06); animation: scrollTermux 18s linear infinite; }
@keyframes scrollTermux{ from { transform: translateY(0); } to { transform: translateY(-50%); } }

/* SATELLITE LOADER */
#satOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--neon); font-family: monospace; letter-spacing: 2px; }
.sat-icon { font-size: 80px; margin-bottom: 20px; animation: pulseSat 1s infinite alternate; }
@keyframes pulseSat { from { opacity: 0.5; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }

/* UI */
#topbar{position:fixed;left:0;right:0;top:6px;z-index:1002;padding:8px 14px;display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:700}
#sidebar { position: fixed; left: 0; top: 50px; bottom: 50px; width: 80px; display: none; flex-direction: column; align-items: center; gap: 15px; z-index: 1001; pointer-events: auto; padding-top: 20px; }
.folder-icon { width: 50px; height: 50px; border: 1px solid var(--neon); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; background: rgba(0,20,0,0.8); transition: 0.2s; }
.folder-icon:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
.folder-label { font-size: 9px; margin-top: 2px; text-transform: uppercase; font-weight:bold;}

#rightRadar { position: fixed; right: 20px; top: 70px; width: 220px; background: rgba(0, 10, 0, 0.8); border: 1px solid var(--neon); z-index: 1000; display: none; flex-direction: column; padding: 10px; pointer-events: auto; border-radius: 8px; }
.radar-scope { width: 180px; height: 180px; border-radius: 50%; border: 1px solid var(--neon); position: relative; margin: 0 auto 10px auto; background: rgba(0,20,0,0.3); overflow: hidden; }
.radar-scan { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: conic-gradient(from 0deg, transparent 0deg, rgba(0,255,102,0.4) 30deg, transparent 30deg); border-radius: 50%; animation: scan 3s linear infinite; }
.radar-blip { position: absolute; width: 6px; height: 6px; background: #fff; border-radius: 50%; box-shadow: 0 0 4px #fff; transform: translate(-50%, -50%); }
@keyframes scan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
#radarList { max-height: 150px; overflow-y: auto; font-size: 10px; }

#loginScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.94),rgba(0,0,0,0.94));z-index:1200}
.loginCard{background:#030303;border:1px solid var(--neon);padding:18px;border-radius:10px;width:min(92vw,480px);text-align:center;box-shadow:0 0 40px rgba(0,255,102,0.02)}
input, textarea{width:100%;padding:10px;margin:8px 0;background:#000;border:1px solid var(--neon);color:var(--neon);border-radius:6px;font-family:monospace;}
button.primary{background:transparent;border:1px solid var(--neon);color:var(--neon);padding:8px 12px;border-radius:6px;font-weight:bold;}
button.primary:hover{background:rgba(0,255,102,0.1)}

#canvas{position:fixed;inset:0;padding:18px;box-sizing:border-box;z-index:10;pointer-events:none;}
#canvas > * { pointer-events: auto; }
.flowContainer{display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:40px}
.node{padding:12px 18px;border-radius:8px;border:1px solid var(--neon);background:linear-gradient(#061,#021);min-width:180px;text-align:center;cursor:pointer; pointer-events: auto; margin: 10px;}
.node:hover{background:var(--neon);color:#001}
.network-grid { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:20px; }
.status-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
.status-active { background-color: #00ff66; box-shadow: 0 0 5px #00ff66; }

.win{position:absolute;background:linear-gradient(#071,#020);border:2px solid var(--neon);min-width:320px;min-height:120px;border-radius:6px;overflow:hidden;box-shadow:0 0 40px rgba(0,255,102,0.06);z-index:600;resize:both; pointer-events: auto;}
.win .hdr{background:#021;padding:6px 8px;display:flex;align-items:center;justify-content:space-between;cursor:move;border-bottom:1px solid rgba(0,255,102,0.06)}
.win .title{font-weight:700}
.win .body{padding:8px;color:var(--neon);font-size:13px;max-height:60vh;overflow:auto}

/* Terminal */
.term-body { background: var(--term-bg); color: #ccc; font-family: 'Courier New', monospace; padding: 10px; height: 300px; overflow-y: auto; font-size: 12px; }
.term-input { background: transparent; border: none; color: #fff; font-family: inherit; flex-grow: 1; outline: none; }
</style>
</head>
<body>

<div id="satOverlay">
    <div class="sat-icon">üõ∞Ô∏è</div>
    <div id="satText">CONNECTING SECRET SATELLITE SERVER OF BISHOP HOUSE...</div>
</div>

<div id="termuxWallpaper" aria-hidden="true"><div id="termuxLayerA" class="termuxLayer"></div></div>

<div id="topbar">
  <div class="brand">BISHOP HOUSE ‚Äî OMNI PORTAL (LIVE)</div>
  <div><span id="who" class="small muted">Not logged in</span> <button id="logoutBtn" style="display:none" class="primary" onclick="location.reload()">Logout</button></div>
</div>

<div id="sidebar">
    <div class="folder-icon" onclick="runWithSat(createTerminalWindow)"><div>üåê</div><div class="folder-label">Access</div></div>
    <div class="folder-icon" onclick="runWithSat(openVault)"><div>üìÅ</div><div class="folder-label">Docs</div></div>
</div>

<div id="rightRadar">
    <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:var(--neon); font-size:11px;">LIVE NETWORK RADAR</div>
    <div class="radar-scope"><div class="radar-scan"></div><div id="radarBlips"></div></div>
    <div id="radarList">Scanning...</div>
</div>

<div id="loginScreen">
  <div class="loginCard">
    <h2 style="margin-bottom:10px">SECURE UPLINK</h2>
    <input id="userIn" type="text" placeholder="Identity" autocomplete="off"/>
    <button class="primary" onclick="doLogin()">CONNECT</button>
  </div>
</div>

<div id="canvas" style="display:none">
  <div class="flowContainer">
      <div id="flowContainer"></div>
  </div>
</div>

<template id="winTpl">
  <div class="win">
    <div class="hdr"><div class="title">TITLE</div><div class="controls"><button class="minBtn">_</button><button class="closeBtn">√ó</button></div></div>
    <div class="body">BODY</div>
  </div>
</template>

<script>
const socket = io(); // Connect to Python Server

let currentUser = null;
let currentLat = 0;
let currentLon = 0;
let zCounter = 100;
let hasConnectedToSat = false;
let networkMembers = []; // Will be filled by Server

/* ---------- 1. LOGIN & SOCKETS ---------- */
function doLogin(){
    const u = document.getElementById('userIn').value.trim();
    if(!u) return;
    
    currentUser = u;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('canvas').style.display='block';
    document.getElementById('sidebar').style.display='flex';
    document.getElementById('rightRadar').style.display='flex';
    document.getElementById('who').innerText = u;
    document.getElementById('logoutBtn').style.display='inline-block';
    document.getElementById('termuxWallpaper').style.display='block';
    
    // Start tracking location
    if(navigator.geolocation){
        navigator.geolocation.watchPosition(pos => {
            currentLat = pos.coords.latitude;
            currentLon = pos.coords.longitude;
            // Send REAL location to server
            socket.emit('update_location', {
                name: currentUser,
                lat: currentLat,
                lon: currentLon,
                role: (u === 'Bishop 1' ? 'supreme' : 'node')
            });
        });
    }
}

// Listen for updates from Server
socket.on('network_update', (members) => {
    networkMembers = members;
    renderFlowchart();
    updateRadar();
});

socket.on('receive_message', (data) => {
    // Only show if addressed to me or public
    // Simple implementation: show all for demo context
    const chatWinId = `chat_${data.sender}`;
    // If window exists, append. Else notify.
    // (Simplified for this snippet: Just alert or console log)
    console.log("New Message:", data);
});

socket.on('terminal_output', (data) => {
    const term = document.querySelector('.term-body');
    if(term) {
        term.innerHTML += `<div>${data.output.replace(/\n/g, '<br>')}</div>`;
        term.scrollTop = term.scrollHeight;
    }
});

/* ---------- 2. RENDERERS ---------- */
function renderFlowchart(){
    const container = document.getElementById('flowContainer');
    container.innerHTML = '';
    
    // Separate Supreme
    const supreme = networkMembers.find(m => m.role === 'supreme');
    if(supreme){
        const div = document.createElement('div');
        div.className = 'node';
        div.innerHTML = `<span class="status-dot status-active"></span>${supreme.name}<br><span class="small muted">SUPREME</span>`;
        div.onclick = () => runWithSat(() => openIntel(supreme));
        container.appendChild(div);
    }
    
    const grid = document.createElement('div');
    grid.className = 'network-grid';
    networkMembers.filter(m => m.role !== 'supreme').forEach(m => {
        const div = document.createElement('div');
        div.className = 'node';
        div.innerHTML = `<span class="status-dot status-active"></span>${m.name}<br><span class="small muted">NODE</span>`;
        div.onclick = () => runWithSat(() => openIntel(m));
        grid.appendChild(div);
    });
    container.appendChild(grid);
}

function updateRadar(){
    const blips = document.getElementById('radarBlips');
    const list = document.getElementById('radarList');
    blips.innerHTML = '';
    list.innerHTML = '';
    
    networkMembers.forEach(m => {
        if(m.name !== currentUser){
            const dist = getDist(currentLat, currentLon, m.lat, m.lon);
            // Visuals
            const angle = Math.random() * 360;
            const r = Math.min(dist/50, 90);
            const top = 50 + r * Math.sin(angle*Math.PI/180);
            const left = 50 + r * Math.cos(angle*Math.PI/180);
            
            blips.innerHTML += `<div class="radar-blip" style="top:${top}%;left:${left}%"></div>`;
            list.innerHTML += `<div>${m.name}: ${dist.toFixed(0)}km</div>`;
        }
    });
}

/* ---------- 3. FEATURES ---------- */
function openIntel(member){
    const html = `
        <div style="padding:10px; text-align:center;">
            <h3>TARGET: ${member.name}</h3>
            <div>COORDS: ${member.lat}, ${member.lon}</div>
            <button class="primary" onclick="openChat('${member.name}')">OPEN SECURE CHAT</button>
        </div>
    `;
    createWindow(`INTEL: ${member.name}`, html, 400, 200);
}

function openChat(target){
    const html = `
        <div id="chatBox_${target}" style="height:200px; background:#111; overflow-y:auto;"></div>
        <div style="display:flex"><input id="msgIn_${target}"><button class="primary" onclick="send('${target}')">SEND</button></div>
    `;
    createWindow(`COMMS: ${target}`, html, 400, 400);
}

function send(target){
    const input = document.getElementById(`msgIn_${target}`);
    socket.emit('send_message', { sender: currentUser, message: input.value, target: target });
    
    // Local echo
    document.getElementById(`chatBox_${target}`).innerHTML += `<div style="color:#0f0">ME: ${input.value}</div>`;
    input.value = '';
}

// REAL TERMINAL
function createTerminalWindow(){
    const html = `
        <div class="term-body">BISHOP OS v8.0<br>Connected to HOST.<br></div>
        <div style="display:flex"><span style="color:#0f0">root@bishop:~#&nbsp;</span><input class="term-input" onkeydown="sendTerm(event)"></div>
    `;
    createWindow('ACCESS THE WORLD', html, 200, 200);
}

function sendTerm(e){
    if(e.key === 'Enter'){
        const cmd = e.target.value;
        const term = document.querySelector('.term-body');
        term.innerHTML += `<div>root@bishop:~# ${cmd}</div>`;
        // Send to Python
        socket.emit('terminal_command', {command: cmd});
        e.target.value = '';
    }
}

/* ---------- UTILS ---------- */
function createWindow(title, html, x, y){
    const tpl = document.getElementById('winTpl').content.cloneNode(true);
    const win = tpl.querySelector('.win');
    win.querySelector('.title').innerText = title;
    win.querySelector('.body').innerHTML = html;
    win.style.left = x+'px'; win.style.top = y+'px';
    win.style.zIndex = ++zCounter;
    
    win.querySelector('.closeBtn').onclick = () => win.remove();
    document.body.appendChild(win);
    
    // Drag logic (Simplified)
    win.querySelector('.hdr').onmousedown = (e) => {
        // ... drag logic same as before ...
    };
    return win;
}

function runWithSat(cb){
    document.getElementById('satOverlay').style.display = 'flex';
    setTimeout(()=>{
        document.getElementById('satOverlay').style.display = 'none';
        cb();
    }, 1500);
}

function getDist(lat1,lon1,lat2,lon2) {
    // Simple approx
    var R = 6371; 
    var dLat = (lat2-lat1) * (Math.PI/180);
    var dLon = (lon2-lon1) * (Math.PI/180); 
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c; 
}

/* ---------- VAULT ---------- */
function openVault(){
    // Standard file logic here...
    createWindow("DOCUMENTS", "Vault Active. Uploads encrypted.", 300, 100);
}
</script>
</body>
</html>