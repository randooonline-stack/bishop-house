<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bishop House ‚Äî Omni Portal</title>
<style>
/* --- CORE STYLES --- */
:root{--neon:#00ff66;--blue:#00aaff;--red:#ff3333;--bg:#000;--muted:#88ffb3;--term-bg:#0c0c0c}
html,body{height:100%;margin:0;background:var(--bg);color:var(--neon);font-family:ui-monospace, Menlo, Monaco, "Courier New", monospace;overflow:hidden}
a{color:var(--neon);text-decoration:none}
button{cursor:pointer}
* { box-sizing: border-box; }

/* Backgrounds */
#bg { position:fixed; inset:0; z-index:0; pointer-events:none; background: radial-gradient(rgba(0,255,102,0.03), rgba(0,0,0,0)); }
#bg svg{width:100%;height:100%;opacity:0.12;filter:contrast(1.05) saturate(1.1)}

#termuxWallpaper{ position:fixed; inset:0; z-index:0; pointer-events:none; background:#000; display:none; overflow:hidden; opacity: 0; transition: opacity 1s; }
#termuxWallpaper.active{ opacity: 1; }
.termuxLayer{ position:absolute; inset:0; font-family:monospace; white-space:pre; line-height:1.05; font-size:12px; color:rgba(0,255,102,0.06); animation: scrollTermux 18s linear infinite; }
.termuxLayer.alt{ animation-delay:-9s; opacity:1; }
@keyframes scrollTermux{ from { transform: translateY(0); } to { transform: translateY(-50%); } }

/* SATELLITE LOADER */
#satOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    color: var(--neon); font-family: monospace; letter-spacing: 2px;
}
.sat-icon { font-size: 80px; margin-bottom: 20px; animation: pulseSat 1s infinite alternate; }
.sat-text { animation: blinkSat 0.2s infinite; text-align: center; max-width: 80%; }
#satSubtext { font-size:12px; margin-top:10px; color:#555; }
@keyframes pulseSat { from { opacity: 0.5; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }
@keyframes blinkSat { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

/* UI Components */
#topbar{position:fixed;left:0;right:0;top:6px;z-index:1002;padding:8px 14px;display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:700}
.small{font-size:12px;color:var(--muted)}

#loginScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.94),rgba(0,0,0,0.94));z-index:1200}
.loginCard{background:#030303;border:1px solid var(--neon);padding:18px;border-radius:10px;width:min(92vw,480px);text-align:center;box-shadow:0 0 40px rgba(0,255,102,0.02)}
input[type=text],input[type=password], textarea{width:100%;padding:10px;margin:8px 0;background:#000;border:1px solid var(--neon);color:var(--neon);border-radius:6px;font-family:monospace;box-sizing: border-box;}
button.primary{background:transparent;border:1px solid var(--neon);color:var(--neon);padding:8px 12px;border-radius:6px;font-weight:bold;}
button.primary:hover{background:rgba(0,255,102,0.1)}

/* SIDEBAR VAULT */
#sidebar {
    position: fixed; left: 0; top: 50px; bottom: 50px; width: 80px;
    display: none; flex-direction: column; align-items: center; gap: 15px;
    z-index: 1001; pointer-events: auto;
    padding-top: 20px;
}
.folder-icon {
    width: 50px; height: 50px;
    border: 1px solid var(--neon); border-radius: 8px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 20px; cursor: pointer; background: rgba(0,20,0,0.8);
    transition: 0.2s;
}
.folder-icon:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
.folder-label { font-size: 9px; margin-top: 2px; text-transform: uppercase; font-weight:bold;}

/* RIGHT SIDE FIXED RADAR */
#rightRadar {
    position: fixed; right: 20px; top: 70px; width: 220px;
    background: rgba(0, 10, 0, 0.8); border: 1px solid var(--neon);
    z-index: 1000; display: none; flex-direction: column; padding: 10px;
    pointer-events: auto; border-radius: 8px;
}
.radar-scope {
    width: 180px; height: 180px; border-radius: 50%; border: 1px solid var(--neon);
    position: relative; margin: 0 auto 10px auto; background: rgba(0,20,0,0.3);
    overflow: hidden;
}
.radar-scan {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: conic-gradient(from 0deg, transparent 0deg, rgba(0,255,102,0.4) 30deg, transparent 30deg);
    border-radius: 50%; animation: scan 3s linear infinite;
}
.radar-blip {
    position: absolute; width: 6px; height: 6px; background: #fff; border-radius: 50%;
    box-shadow: 0 0 4px #fff; transform: translate(-50%, -50%);
}
@keyframes scan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
#radarList { max-height: 150px; overflow-y: auto; font-size: 10px; }

/* MAIN CANVAS */
#canvas{position:fixed;inset:0;padding:18px;box-sizing:border-box;z-index:10;pointer-events:none;}
#canvas > * { pointer-events: auto; }

/* Dynamic Flowchart */
.flowContainer{display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:40px}
.node{padding:12px 18px;border-radius:8px;border:1px solid var(--neon);background:linear-gradient(#061,#021);min-width:180px;text-align:center;cursor:pointer; pointer-events: auto; margin: 10px;}
.node:hover{background:var(--neon);color:#001}
.network-grid { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:20px; }

/* Status Indicators */
.status-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
.status-active { background-color: #00ff66; box-shadow: 0 0 5px #00ff66; }
.status-offline { background-color: #555; }

/* Windows */
.win{position:absolute;background:linear-gradient(#071,#020);border:2px solid var(--neon);min-width:320px;min-height:120px;border-radius:6px;overflow:hidden;box-shadow:0 0 40px rgba(0,255,102,0.06);z-index:600;resize:both; pointer-events: auto;}
.win .hdr{background:#021;padding:6px 8px;display:flex;align-items:center;justify-content:space-between;cursor:move;border-bottom:1px solid rgba(0,255,102,0.06)}
.win .hdr .title{font-weight:700}
.win .hdr button{background:transparent;border:1px solid var(--neon);color:var(--neon);padding:2px 6px;margin-left:4px;border-radius:4px;}
.win .body{padding:8px;color:var(--neon);font-size:13px;max-height:60vh;overflow:auto}

/* File Vault Styles */
.file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
.file-item { border: 1px solid #333; padding: 5px; text-align: center; cursor: pointer; border-radius: 4px; transition: 0.2s; position:relative; }
.file-item:hover { border-color: var(--neon); background: rgba(0,255,102,0.1); }
.file-icon { font-size: 24px; }
.file-name { font-size: 10px; margin-top: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
.file-actions { display:flex; gap:2px; justify-content:center; margin-top:4px; }
.btn-xs { font-size: 9px; padding: 2px 4px; border: 1px solid var(--neon); color: var(--neon); background: none; }
.btn-xs:hover { background: var(--neon); color: black; }

/* Terminal Styles */
.term-body { background: var(--term-bg); color: #ccc; font-family: 'Courier New', monospace; padding: 10px; height: 300px; overflow-y: auto; font-size: 12px; }
.term-line { margin-bottom: 2px; word-break: break-all; }
.term-input-line { display: flex; color: var(--neon); margin-top: 5px; }
.term-prompt { margin-right: 8px; font-weight: bold; }
.term-input { background: transparent; border: none; color: #fff; font-family: inherit; flex-grow: 1; outline: none; }
.txt-green { color: var(--neon); } .txt-red { color: #ff3333; } .txt-blue { color: var(--blue); }

/* Taskbar */
#taskbar{position:fixed;left:0;right:0;bottom:0;height:46px;background:rgba(0,0,0,0.9);display:flex;align-items:center;gap:8px;padding:6px 8px;border-top:1px solid rgba(0,255,102,0.2);z-index:1100; pointer-events: auto;}
.taskItem{background:#041;border:1px solid rgba(0,255,102,0.12);padding:6px 10px;border-radius:6px;color:#001;cursor:pointer;min-width:100px;text-align:center}

.msg-me { color: var(--neon); font-weight:bold; }
.msg-them { color: var(--blue); font-weight:bold; }
.copyright { position: fixed; bottom: 8px; right: 8px; color: var(--muted); font-size: 10px; text-transform: uppercase; z-index: 1101; }
</style>
</head>
<body>

<div id="satOverlay">
    <div class="sat-icon">üõ∞Ô∏è</div>
    <div class="sat-text" id="satText">CONNECTING SECRET SATELLITE SERVER OF BISHOP HOUSE...</div>
    <div id="satSubtext">ENCRYPTING UPLINK</div>
</div>

<div id="termuxWallpaper" aria-hidden="true">
  <div id="termuxLayerA" class="termuxLayer" aria-hidden="true"></div>
  <div id="termuxLayerB" class="termuxLayer alt" aria-hidden="true"></div>
</div>

<div id="bg" aria-hidden="true">
<svg viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet"><rect width="100%" height="100%" fill="#000"/>
  <defs><radialGradient id="cg" cx="50%" cy="45%" r="60%"><stop offset="0%" stop-color="#00ff66" stop-opacity="0.08"/><stop offset="100%" stop-color="#00ff66" stop-opacity="0.02"/></radialGradient></defs>
  <g transform="translate(500,500) scale(0.95)"><circle cx="0" cy="0" r="300" fill="url(#cg)"></circle>
  <g stroke="#00ff66" stroke-opacity="0.18" stroke-width="2" fill="none"><path d="M-260,-40 C -180,-170 -70,-210 0,-230"/><path d="M260,-40 C 180,-170 70,-210 0,-230"/><path d="M-220,40 C -120,120 -60,180 0,210"/><path d="M220,40 C 120,120 60,180 0,210"/></g></g>
</svg>
</div>

<div id="topbar">
  <div class="brand">BISHOP HOUSE ‚Äî CYBERPORTAL</div>
  <div>
    <span id="who" class="small muted">Not logged in</span>
    <button id="logoutBtn" style="margin-left:12px;display:none" class="primary" onclick="doLogout()">Logout</button>
  </div>
</div>

<div id="sidebar">
    <div class="folder-icon" onclick="runWithSat(openVault)">
        <div>üìÅ</div><div class="folder-label">Docs</div>
    </div>
    <div class="folder-icon" onclick="runWithSat(createTerminalWindow)">
        <div>üåê</div><div class="folder-label">Access</div>
    </div>
    <div class="folder-icon" onclick="runWithSat(openEncoder)">
        <div>üîí</div><div class="folder-label">Encode</div>
    </div>
    <div class="folder-icon" onclick="runWithSat(openDecoder)">
        <div>üîì</div><div class="folder-label">Decode</div>
    </div>
    <div class="folder-icon" onclick="runWithSat(openNetworkManager)">
        <div>üë•</div><div class="folder-label">Manage</div>
    </div>
</div>

<div id="rightRadar">
    <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:var(--neon); font-size:11px;">PROXIMITY SCAN</div>
    <div class="radar-scope">
        <div class="radar-scan"></div>
        <div id="radarBlips"></div>
    </div>
    <div id="radarList">Initializing...</div>
</div>

<div id="loginScreen">
  <div class="loginCard">
    <pre style="color:var(--neon);font-size:12px;line-height:1.05em;margin-bottom:12px;white-space:pre-wrap">
          /\          
         /  \         
        /++++\        
       /  /\  \        
      /__/  \__\      
          \/           
    </pre>
    <h2 style="margin-bottom:10px">ACCESS CONTROL</h2>
    <div style="margin-top:8px">
      <input id="userIn" type="text" placeholder="Username" autocomplete="off"/>
      <input id="passIn" type="password" placeholder="Password" autocomplete="off"/>
      <div style="margin-top:10px">
        <button class="primary" onclick="doLogin()">AUTHENTICATE</button>
      </div>
      <div id="loginMsg" style="margin-top:8px;color:#f66"></div>
    </div>
    <div style="margin-top:18px; text-align:left; font-size:12px; color:var(--muted); border-top:1px dashed var(--neon); padding-top:12px">
"When you're a light instead of a dim switch, your brightness radiates in every direction."
    </div>
  </div>
</div>

<div id="canvas" style="display:none">
  <div style="position:relative;z-index:2;height:100%">
    <div id="flowContainer" class="flowContainer">
        </div>
  </div>
</div>

<div id="taskbar"></div>
<div class="copyright">Copyrights ¬© Shargin Sooraj</div>

<template id="winTpl">
  <div class="win">
    <div class="hdr"><div class="title">TITLE</div><div class="controls"><button class="minBtn">_</button><button class="closeBtn">√ó</button></div></div>
    <div class="body">BODY</div>
  </div>
</template>

<input type="file" id="vaultUpload" style="display:none" onchange="handleFileUpload(this)">

<script>
/* ---------- 1. DATA PERSISTENCE & INIT ---------- */
// Added 'recruiter' field to determine who added whom
const DEFAULT_MEMBERS = [
    { name: "Bishop 1", role: "supreme", lat: 38.8977, lon: -77.0365, lastActive: 0, recruiter: "System" }, 
    { name: "Bishop A", role: "node", lat: 24.7136, lon: 46.6753, lastActive: 0, recruiter: "Bishop 1" },     
    { name: "Bishop N", role: "node", lat: 9.9312, lon: 76.2673, lastActive: 0, recruiter: "Bishop 1" }      
];

let networkMembers = JSON.parse(localStorage.getItem('bishop_members')) || DEFAULT_MEMBERS;

const DEFAULT_WALLPAPER = `0xA3F2: load /opt/cicada \n> seeking knowledge... [ok]`;
let zCounter = 600;
const taskbar = document.getElementById('taskbar');
const who = document.getElementById('who');
let hasConnectedToSat = false;
let currentUser = null;

/* ---------- 2. LOGIN / LOGOUT ---------- */
function doLogin(){
  const u = document.getElementById('userIn').value.trim();
  const p = document.getElementById('passIn').value;
  
  let validName = null;
  const exactMatch = networkMembers.find(m => m.name === u);
  const spaceMatch = networkMembers.find(m => m.name.replace(/\s/g, '') === u);

  if (exactMatch && p === u) validName = exactMatch.name;
  else if (spaceMatch && p === u) validName = spaceMatch.name;

  if(validName){
    currentUser = validName;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('canvas').style.display = 'block';
    document.getElementById('sidebar').style.display = 'flex';
    document.getElementById('rightRadar').style.display = 'flex';
    who.innerText = validName;
    document.getElementById('logoutBtn').style.display = 'inline-block';
    
    enableTermuxWallpaper(true);
    hasConnectedToSat = false; 
    
    updateMyRealLocation();
    renderFlowchart();
    openDesktopWidgets();
    updateRadar();
    
  } else {
    document.getElementById('loginMsg').innerText = 'ACCESS DENIED';
  }
}

function doLogout(){
  currentUser = null;
  document.querySelectorAll('.win').forEach(w => w.remove());
  taskbar.innerHTML = '';
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('canvas').style.display = 'none';
  document.getElementById('sidebar').style.display = 'none';
  document.getElementById('rightRadar').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('userIn').value = '';
  document.getElementById('passIn').value = '';
  enableTermuxWallpaper(false);
}

function enableTermuxWallpaper(on){
  const term = document.getElementById('termuxWallpaper');
  if(on){ term.style.display = 'block'; setTimeout(()=>term.classList.add('active'),10); }
  else { term.style.display = 'none'; term.classList.remove('active'); }
  const block = (DEFAULT_WALLPAPER + '\n').repeat(20);
  document.getElementById('termuxLayerA').textContent = block;
  document.getElementById('termuxLayerB').textContent = block;
}

/* ---------- 3. DYNAMIC NETWORK RENDERER ---------- */
function renderFlowchart(){
    const container = document.getElementById('flowContainer');
    container.innerHTML = '';
    const isActive = (timestamp) => (Date.now() - timestamp) < 86400000; 

    const supreme = networkMembers.find(m => m.role === 'supreme');
    if(supreme) {
        const supDiv = document.createElement('div');
        supDiv.className = 'node';
        const statusClass = isActive(supreme.lastActive) ? 'status-active' : 'status-offline';
        supDiv.innerHTML = `<span class="status-dot ${statusClass}"></span>${supreme.name}<br><span class="small muted">SUPREME</span>`;
        supDiv.onclick = () => runWithSat(() => handleNodeClick(supreme));
        container.appendChild(supDiv);
    }

    const grid = document.createElement('div');
    grid.className = 'network-grid';
    
    networkMembers.filter(m => m.role !== 'supreme').forEach(m => {
        const node = document.createElement('div');
        node.className = 'node';
        const statusClass = isActive(m.lastActive) ? 'status-active' : 'status-offline';
        node.innerHTML = `<span class="status-dot ${statusClass}"></span>${m.name}<br><span class="small muted">NODE</span>`;
        node.onclick = () => runWithSat(() => handleNodeClick(m));
        grid.appendChild(node);
    });
    
    container.appendChild(grid);
}

/* ---------- 4. NODE CLICK LOGIC (UNIVERSAL) ---------- */
async function handleNodeClick(targetMember){
    const isSelf = targetMember.name === currentUser;
    let lat = targetMember.lat;
    let lon = targetMember.lon;
    let locName = "ENCRYPTED SECTOR";
    
    try {
        const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
        const data = await res.json();
        if(data.city || data.countryName) locName = `${data.city || ''}, ${data.countryName}`.toUpperCase();
    } catch(e) {}

    const uplinkHtml = `
        <div style="padding:10px; text-align:center;">
            <div style="color:var(--neon); font-weight:bold;">UPLINK ESTABLISHED</div>
            <hr style="border-color:var(--neon); opacity:0.3; margin:10px 0;">
            <div style="margin-bottom:10px; text-align:left;">
                <div style="color:#888; font-size:10px;">IDENTITY</div>
                <div style="font-weight:bold;">${targetMember.name}</div>
            </div>
            <div style="margin-bottom:10px; text-align:left;">
                <div style="color:#888; font-size:10px;">LOCATION</div>
                <div style="color:#0f0;">‚óè ${locName}</div>
                <div style="font-family:monospace; font-size:11px;">${lat.toFixed(4)}, ${lon.toFixed(4)}</div>
            </div>
            <div style="margin-bottom:10px; text-align:left;">
                <div style="color:#888; font-size:10px;">STATUS</div>
                <div>${(Date.now() - targetMember.lastActive < 86400000) ? "<span style='color:var(--neon)'>ONLINE</span>" : "<span style='color:#555'>OFFLINE</span>"}</div>
            </div>
        </div>
    `;
    createWindow(`INTEL: ${targetMember.name}`, uplinkHtml, 450, 150);

    const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.5},${lat-0.5},${lon+0.5},${lat+0.5}&layer=mapnik&marker=${lat},${lon}`;
    createWindow(`${targetMember.name} ‚Ä¢ SAT`, `<iframe width="100%" height="250" frameborder="0" src="${mapUrl}"></iframe>`, 80, 150);

    fetchLocationNews(locName, targetMember.name);

    if(!isSelf) createMemberChatWin(targetMember.name, 800, 400);
}

function fetchLocationNews(locationName, memberName){
    const cleanLoc = locationName.split(',')[0] || "Global";
    const winId = `news-${memberName.replace(/\s/g,'')}`;
    createWindow(`INTERCEPTED: ${cleanLoc}`, `<div id="${winId}">Decrypting feeds...</div>`, 800, 150);
    setTimeout(() => {
        const el = document.getElementById(winId);
        if(el) {
            el.innerHTML = `
                <ul style="padding-left:15px; font-size:12px;">
                    <li style="margin-bottom:8px;">High encrypted traffic reported in ${cleanLoc}.</li>
                    <li style="margin-bottom:8px;">${memberName}: Neural link stable.</li>
                    <li style="margin-bottom:8px;">Local authorities in ${cleanLoc} reporting grid anomaly.</li>
                </ul>
            `;
        }
    }, 1000);
}

function updateMyRealLocation(){
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const memberIndex = networkMembers.findIndex(m => m.name === currentUser);
            if(memberIndex > -1){
                networkMembers[memberIndex].lat = lat;
                networkMembers[memberIndex].lon = lon;
                networkMembers[memberIndex].lastActive = Date.now();
                saveAndRefreshNetwork();
                updateRadar(); 
            }
        });
    }
}

/* ---------- 5. PERSISTENT RADAR LOGIC ---------- */
function updateRadar() {
    const myData = networkMembers.find(m => m.name === currentUser);
    if(!myData) return;

    const blipsContainer = document.getElementById('radarBlips');
    const listContainer = document.getElementById('radarList');
    
    blipsContainer.innerHTML = '';
    let listHtml = '';
    let nearbyList = [];
    
    networkMembers.forEach(m => {
        if(m.name !== currentUser) {
            const dist = getDistanceFromLatLonInKm(myData.lat, myData.lon, m.lat, m.lon);
            const angle = Math.random() * 360;
            const radius = Math.min(dist / 50, 90); 
            const top = 50 + radius * Math.sin(angle * Math.PI / 180);
            const left = 50 + radius * Math.cos(angle * Math.PI / 180);
            
            const blip = document.createElement('div');
            blip.className = 'radar-blip';
            blip.style.top = top + '%';
            blip.style.left = left + '%';
            blip.title = `${m.name} (${dist.toFixed(0)}km)`;
            blipsContainer.appendChild(blip);
            
            nearbyList.push({ name: m.name, dist: dist });
        }
    });
    
    nearbyList.sort((a,b) => a.dist - b.dist);
    
    if(nearbyList.length === 0) {
        listHtml = `<div class="muted">NO ACTIVE SIGNALS</div>`;
    } else {
        nearbyList.forEach(item => {
            let color = item.dist < 50 ? '#ff3333' : (item.dist < 1000 ? 'var(--neon)' : '#555');
            let label = item.dist < 50 ? 'VICINITY' : (item.dist < 1000 ? 'REGIONAL' : 'GLOBAL');
            listHtml += `<div style="color:${color}; display:flex; justify-content:space-between; margin-bottom:4px; border-bottom:1px solid #222;">
                        <span>${item.name}</span>
                        <span>${item.dist.toFixed(0)}KM [${label}]</span>
                     </div>`;
        });
    }
    listContainer.innerHTML = listHtml;
}

function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
  var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  return R * c; 
}
function deg2rad(deg) { return deg * (Math.PI/180); }


/* ---------- 6. SECURE VAULT (DEAD DROP - FIXED) ---------- */
function openVault(){
    const win = createWindow('üìÅ CLASSIFIED DOCUMENTS', '<div id="vaultContent">Loading...</div>', 300, 100);
    renderVaultContent(win.querySelector('#vaultContent'));
}

function renderVaultContent(container){
    // "Receive" Section Logic (Top of Vault)
    let html = `
        <div style="background:#111; padding:10px; margin-bottom:15px; border:1px solid #333;">
            <div style="font-size:10px; color:var(--neon); margin-bottom:5px;">SECURE RETRIEVAL (DEAD DROP)</div>
            <div style="display:flex; gap:5px;">
                <input id="dropCode" placeholder="ACCESS CODE" style="width:40%">
                <input id="dropPass" placeholder="PASSWORD" type="password" style="width:40%">
                <button class="primary" onclick="retrieveDeadDrop()">FETCH</button>
            </div>
        </div>
        <div style="border-bottom:1px solid var(--neon); padding-bottom:8px; margin-bottom:8px; display:flex; justify-content:space-between;">
            <span style="font-weight:bold;">LOCAL REPOSITORY</span>
            <button class="primary" onclick="document.getElementById('vaultUpload').click()">+ UPLOAD</button>
        </div>
        <div class="file-grid">
    `;
    
    const files = JSON.parse(localStorage.getItem('bishop_vault') || '[]');
    files.forEach(f => {
        html += `
            <div class="file-item">
                <div class="file-icon">${f.type.includes('image') ? 'üñºÔ∏è' : 'üìÑ'}</div>
                <div class="file-name" title="${f.name}">${f.name}</div>
                <div class="file-actions">
                    <button class="btn-xs" onclick="downloadFile(${f.id})">‚¨á</button>
                    <button class="btn-xs" onclick="createDeadDrop(${f.id})">üîó</button>
                    <button class="btn-xs" onclick="deleteFile(${f.id})" style="color:red; border-color:red;">X</button>
                </div>
            </div>
        `;
    });
    
    if(files.length === 0) html += `<div class="muted" style="padding:10px;">Repository Empty.</div>`;
    html += `</div>`;
    container.innerHTML = html;
}

function handleFileUpload(input){
    if(input.files && input.files[0]){
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const files = JSON.parse(localStorage.getItem('bishop_vault') || '[]');
            files.push({ id: Date.now(), name: file.name, type: file.type, data: e.target.result });
            localStorage.setItem('bishop_vault', JSON.stringify(files));
            // Force Refresh
            const win = Array.from(document.querySelectorAll('.win')).find(w => w.querySelector('.title').innerText.includes('CLASSIFIED'));
            if(win) renderVaultContent(win.querySelector('#vaultContent'));
        };
        reader.readAsDataURL(file);
    }
    input.value = ''; 
}

function createDeadDrop(id){
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    const pass = Math.random().toString(36).substring(2, 8);
    const files = JSON.parse(localStorage.getItem('bishop_vault') || '[]');
    const file = files.find(f => f.id === id);
    if(file){
        const drops = JSON.parse(localStorage.getItem('bishop_drops') || '{}');
        drops[code] = { pass: pass, file: file };
        localStorage.setItem('bishop_drops', JSON.stringify(drops));
        const html = `
            <div style="text-align:center; padding:10px;">
                <div style="color:var(--neon); font-weight:bold;">DEAD DROP CREATED</div>
                <div style="background:#111; padding:5px; margin:10px 0; border:1px solid #333;">
                    <div style="color:#888; font-size:10px;">CODE</div>
                    <div style="font-size:18px; letter-spacing:2px; user-select:all;">${code}</div>
                </div>
                <div style="background:#111; padding:5px; margin-bottom:10px; border:1px solid #333;">
                    <div style="color:#888; font-size:10px;">PASSWORD</div>
                    <div style="font-size:14px; color:#ff3333; user-select:all;">${pass}</div>
                </div>
                <div style="font-size:10px; color:var(--muted);">Share these credentials to allow retrieval.</div>
            </div>
        `;
        createWindow('üîó SECURE SHARE', html, 300, 200);
    }
}

function retrieveDeadDrop(){
    const code = document.getElementById('dropCode').value.toUpperCase().trim();
    const pass = document.getElementById('dropPass').value.trim();
    const drops = JSON.parse(localStorage.getItem('bishop_drops') || '{}');
    if(drops[code] && drops[code].pass === pass){
        const file = drops[code].file;
        const files = JSON.parse(localStorage.getItem('bishop_vault') || '[]');
        // New ID to avoid conflicts
        file.id = Date.now(); 
        files.push(file);
        localStorage.setItem('bishop_vault', JSON.stringify(files));
        alert(`ACCESS GRANTED. FILE RETRIEVED: ${file.name}`);
        const win = Array.from(document.querySelectorAll('.win')).find(w => w.querySelector('.title').innerText.includes('CLASSIFIED'));
        if(win) renderVaultContent(win.querySelector('#vaultContent'));
    } else {
        alert("ACCESS DENIED. INVALID CREDENTIALS.");
    }
}

function deleteFile(id){
    if(!confirm("DELETE?")) return;
    let files = JSON.parse(localStorage.getItem('bishop_vault') || '[]');
    files = files.filter(f => f.id !== id);
    localStorage.setItem('bishop_vault', JSON.stringify(files));
    const win = Array.from(document.querySelectorAll('.win')).find(w => w.querySelector('.title').innerText.includes('CLASSIFIED'));
    if(win) renderVaultContent(win.querySelector('#vaultContent'));
}

function downloadFile(id){
    const files = JSON.parse(localStorage.getItem('bishop_vault') || '[]');
    const file = files.find(f => f.id === id);
    if(file){ const a = document.createElement('a'); a.href = file.data; a.download = file.name; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
}

/* ---------- 7. SATELLITE ANIMATION ---------- */
function runWithSat(callback, forceSat = false) {
    if (hasConnectedToSat && !forceSat) {
        callback();
    } else {
        const overlay = document.getElementById('satOverlay');
        const text = document.getElementById('satText');
        if(forceSat) text.innerText = "ALLOCATING ENCRYPTED VOICE BANDWIDTH...";
        else text.innerText = "CONNECTING SECRET SATELLITE SERVER OF BISHOP HOUSE...";
        
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.style.display = 'none';
            hasConnectedToSat = true;
            callback();
        }, 1500);
    }
}

/* ---------- 8. NETWORK MANAGEMENT (Strict Hierarchy) ---------- */
function openNetworkManager(){
    const html = `
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input id="newBishopName" placeholder="Name" style="flex:1;">
            <button class="primary" onclick="addBishop()">RECRUIT</button>
        </div>
        <div id="memberList" style="max-height:200px; overflow-y:auto; border:1px solid #333; padding:5px;">
            ${renderMemberList()}
        </div>
    `;
    createWindow('üë• NETWORK MANAGER', html, 150, 150);
}

function renderMemberList(){
    return networkMembers.map(m => {
        // Logic: You can only remove if YOU are the recruiter
        const canRemove = (m.recruiter === currentUser);
        const btn = canRemove ? `<button class="btn-xs" style="color:red; border-color:red;" onclick="removeBishop('${m.name}')">EXILE</button>` : '';
        const badge = m.recruiter ? `<span style="font-size:9px; color:#666;">(Added by ${m.recruiter})</span>` : '';
        
        return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #222; padding:5px;">
            <span>${m.name} ${badge}</span>
            ${m.role !== 'supreme' ? btn : ''}
        </div>`;
    }).join('');
}

function addBishop(){
    const name = document.getElementById('newBishopName').value;
    if(!name) return alert("Missing intel.");
    
    networkMembers.push({ 
        name: name, 
        role: "node", 
        lat: 0, 
        lon: 0, 
        lastActive: 0,
        recruiter: currentUser // Store who added them
    });
    
    saveAndRefreshNetwork();
    const win = Array.from(document.querySelectorAll('.win')).find(w => w.querySelector('.title').innerText.includes('MANAGER'));
    if(win) win.querySelector('#memberList').innerHTML = renderMemberList();
    updateRadar();
}

function removeBishop(name){
    if(!confirm(`Exile ${name}?`)) return;
    networkMembers = networkMembers.filter(m => m.name !== name);
    saveAndRefreshNetwork();
    const win = Array.from(document.querySelectorAll('.win')).find(w => w.querySelector('.title').innerText.includes('MANAGER'));
    if(win) win.querySelector('#memberList').innerHTML = renderMemberList();
    updateRadar();
}

function saveAndRefreshNetwork(){
    localStorage.setItem('bishop_members', JSON.stringify(networkMembers));
    renderFlowchart();
}

/* ---------- 9. REAL TERMINAL TOOLS ---------- */
function createTerminalWindow(){
  const termId = 'term_' + Math.floor(Math.random()*1000);
  const html = `
    <div id="${termId}_out" class="term-body" onclick="document.getElementById('${termId}_in').focus()">
      <div class="txt-green">ACCESS THE WORLD - ROOT SHELL v3.0</div>
      <div>Real Tools Loaded. Type 'help'.</div><br>
    </div>
    <div class="term-input-line">
      <span class="term-prompt">root@bishop:~#</span>
      <input id="${termId}_in" class="term-input" type="text" autocomplete="off" onkeydown="handleTerm(event, '${termId}')">
    </div>
  `;
  const win = createWindow('ACCESS THE WORLD', html, 300, 300);
  win.querySelector('.body').style.padding = '0';
  win.querySelector('.body').style.background = '#0c0c0c';
  setTimeout(() => document.getElementById(`${termId}_in`).focus(), 100);
}

function handleTerm(e, id){
  if(e.key === 'Enter'){
    const input = document.getElementById(`${id}_in`);
    const out = document.getElementById(`${id}_out`);
    const val = input.value.trim();
    out.innerHTML += `<div><span class="term-prompt">root@bishop:~#</span> ${escapeHTML(val)}</div>`;
    const args = val.split(' '); const cmd = args[0].toLowerCase();

    if(cmd === 'help') {
        out.innerHTML += `<div class="txt-blue">TOOLS: ip, speed, pass, calc, clean</div>`;
    } else if(cmd === 'clean') {
        out.innerHTML = '';
    } else if(cmd === 'ip') {
        out.innerHTML += `<div>Fetching IP...</div>`;
        fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>out.innerHTML+=`<div class="txt-green">IP: ${d.ip}</div>`);
    } else if(cmd === 'speed') {
        const start = Date.now();
        fetch(window.location.href, {cache: "no-store"}).then(()=>{ out.innerHTML+=`<div class="txt-green">PING: ${Date.now()-start}ms</div>`; });
    } else if(cmd === 'pass') {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
        let pass = ""; for(let i=0; i<16; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
        out.innerHTML += `<div class="txt-green">KEY: ${pass}</div>`;
    } else if(cmd === 'calc') {
        try { out.innerHTML += `<div class="txt-blue">= ${eval(val.substring(5))}</div>`; } catch(e){ out.innerHTML += `<div class="txt-red">Error</div>`; }
    } else {
        out.innerHTML += `<div class="txt-blue">>> INTENT DETECTED: AUTO-EXECUTING...</div>`;
        let i=0; const t=setInterval(()=>{ if(i>3){clearInterval(t);out.innerHTML+=`<div class="txt-green">SUCCESS</div>`;out.scrollTop=out.scrollHeight;return;} out.innerHTML+=`<div class="muted">Running process ${i}...</div>`; out.scrollTop=out.scrollHeight; i++; },300);
    }
    input.value = ''; out.scrollTop = out.scrollHeight;
  }
}

/* ---------- 10. ENCODER/DECODER ---------- */
const MORSE_CODE = { 'A':'.-', 'B':'-...', 'C':'-.-.', 'D':'-..', 'E':'.', 'F':'..-.', 'G':'--.', 'H':'....', 'I':'..', 'J':'.---', 'K':'-.-', 'L':'.-..', 'M':'--', 'N':'-.', 'O':'---', 'P':'.--.', 'Q':'--.-', 'R':'.-.', 'S':'...', 'T':'-', 'U':'..-', 'V':'...-', 'W':'.--', 'X':'-..-', 'Y':'-.--', 'Z':'--..', '1':'.----', '2':'..---', '3':'...--', '4':'....-', '5':'.....', '6':'-....', '7':'--...', '8':'---..', '9':'----.', '0':'-----', ' ': '/' };

function openEncoder(){
    const id = 'enc_' + Math.floor(Math.random()*1000);
    const html = `
        <div style="display:flex; flex-direction:column; gap:8px;">
            <textarea id="${id}_in" placeholder="Enter plaintext secret..." rows="4" style="resize:none;"></textarea>
            <div style="display:flex; gap:5px;">
                <button class="primary" style="flex:1" onclick="encodeText('${id}', 'morse')">TO MORSE</button>
                <button class="primary" style="flex:1" onclick="encodeText('${id}', 'hex')">TO HEX</button>
            </div>
            <textarea id="${id}_out" readonly placeholder="Output..." rows="4" style="background:#050505; color:var(--muted); border:1px dashed var(--neon);"></textarea>
        </div>
    `;
    createWindow('üîí ENCRYPTION TOOL', html, 150, 150);
}

function openDecoder(){
    const id = 'dec_' + Math.floor(Math.random()*1000);
    const html = `
        <div style="display:flex; flex-direction:column; gap:8px;">
            <textarea id="${id}_in" placeholder="Enter encoded message..." rows="4" style="resize:none;"></textarea>
            <div style="display:flex; gap:5px;">
                <button class="primary" style="flex:1" onclick="decodeText('${id}', 'morse')">FROM MORSE</button>
                <button class="primary" style="flex:1" onclick="decodeText('${id}', 'hex')">FROM HEX</button>
            </div>
            <textarea id="${id}_out" readonly placeholder="Decrypted output..." rows="4" style="background:#050505; color:var(--blue); border:1px dashed var(--blue);"></textarea>
        </div>
    `;
    createWindow('üîì DECRYPTION TOOL', html, 450, 150);
}

function encodeText(id, type){
    const txt = document.getElementById(id+'_in').value.toUpperCase();
    const out = document.getElementById(id+'_out');
    if(type === 'morse'){
        out.value = txt.split('').map(c => MORSE_CODE[c] || c).join(' ');
    } else if(type === 'hex'){
        let hex = '';
        for(let i=0;i<txt.length;i++) hex += ''+txt.charCodeAt(i).toString(16);
        out.value = hex;
    }
}

function decodeText(id, type){
    const txt = document.getElementById(id+'_in').value;
    const out = document.getElementById(id+'_out');
    if(type === 'morse'){
        const REVERSE_MORSE = Object.fromEntries(Object.entries(MORSE_CODE).map(([k, v]) => [v, k]));
        out.value = txt.split(' ').map(c => REVERSE_MORSE[c] || c).join('');
    } else if(type === 'hex'){
        let str = '';
        for (let i = 0; i < txt.length; i += 2) str += String.fromCharCode(parseInt(txt.substr(i, 2), 16));
        out.value = str;
    }
}

/* ---------- 11. UTILS & WINDOW SYSTEM ---------- */
function createWindow(title, htmlBody, left=100, top=100){
  const tpl = document.getElementById('winTpl').content.cloneNode(true);
  const win = tpl.querySelector('.win');
  win.querySelector('.title').innerText = title;
  win.querySelector('.body').innerHTML = htmlBody;
  document.body.appendChild(win);
  win.style.left = (left + Math.floor(Math.random()*30)) + 'px';
  win.style.top = (top + Math.floor(Math.random()*30)) + 'px';
  win.style.zIndex = ++zCounter;
  win.querySelector('.closeBtn').onclick = () => win.remove();
  win.querySelector('.minBtn').onclick = () => { win.style.display='none'; };
  
  const hdr = win.querySelector('.hdr');
  hdr.addEventListener('mousedown', (e) => {
    win.style.zIndex = ++zCounter;
    let shiftX = e.clientX - win.getBoundingClientRect().left;
    let shiftY = e.clientY - win.getBoundingClientRect().top;
    function moveAt(pageX, pageY) { win.style.left = pageX - shiftX + 'px'; win.style.top = pageY - shiftY + 'px'; }
    function onMouseMove(event) { moveAt(event.pageX, event.pageY); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function() { document.removeEventListener('mousemove', onMouseMove); document.onmouseup = null; };
  });
  hdr.ondragstart = function() { return false; };
  return win;
}

function openDesktopWidgets(){
  createWindow('Encrypted News', `<div id="admin-news">Loading...</div>`, 50, 50);
  document.getElementById('admin-news').innerHTML = '<ul><li>Secure Uplink Established</li><li>Global monitoring active</li></ul>';
}

function createMemberChatWin(target, left, top){
  const key = `chat_${target.replace(/\s/g,'')}`;
  const html = `
    <div id="log_${key}" style="height:150px; overflow-y:auto; border:1px solid #333; margin-bottom:5px; padding:5px;"></div>
    <div style="display:flex; gap:5px;">
      <input id="in_${key}" type="text" style="flex:1;" placeholder="Type...">
      <button class="primary" onclick="sendMsg('${key}')">SEND</button>
    </div>
    <button class="primary" style="width:100%; margin-top:5px;" onclick="runWithSat(function(){ alert('VOICE LINK ACTIVE') }, true)">üìû SECURE VOICE</button>
  `;
  createWindow(`Comms: ${target}`, html, left, top);
  loadChat(key);
}

function sendMsg(key){
  const input = document.getElementById(`in_${key}`);
  const msg = input.value;
  if(!msg) return;
  const log = document.getElementById(`log_${key}`);
  log.innerHTML += `<div><span class="msg-me">Me:</span> ${escapeHTML(msg)}</div>`;
  input.value = '';
  let history = JSON.parse(localStorage.getItem(key) || "[]");
  history.push({sender: "Me", txt: msg});
  localStorage.setItem(key, JSON.stringify(history));
}

function loadChat(key){
  const log = document.getElementById(`log_${key}`);
  if(!log) return;
  let history = JSON.parse(localStorage.getItem(key) || "[]");
  history.forEach(h => { log.innerHTML += `<div><span class="msg-me">Me:</span> ${escapeHTML(h.txt)}</div>`; });
}

function escapeHTML(s){ return (s+'').replace(/&/g,'&').replace(/</g,'<').replace(/>/g,'>'); }

</script>
</body>
</html>
